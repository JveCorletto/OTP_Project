@{
    ViewData["Title"] = "Configurar Authenticator";
}

<div class="container mt-4 text-center">
    @if (TempData["Exito"] != null) { <div class="alert alert-success">@TempData["Exito"]</div> }
    @if (TempData["Error"] != null) { <div class="alert alert-danger">@TempData["Error"]</div> }

    @if (ViewBag.Activado != null && (bool)ViewBag.Activado)
    {
        <div class="alert alert-info">
            ✅ Tu Autenticación en 2 pasos ya está <strong>activa</strong>.<br />
            Si deseas <strong>desactivarla</strong>, ingresa un código válido del Authenticator.
        </div>

        <form asp-action="DesactivarAuthenticator" asp-controller="Auth" method="post" class="mt-3 d-flex flex-column align-items-center gap-3">
            <div class="w-100" style="max-width:360px;">
                <label for="codigo_off" class="form-label fw-bold">Código del Authenticator</label>
                <input type="text" id="codigo_off" name="codigo"
                       maxlength="9" placeholder="XXX - XXX"
                       class="form-control text-center fs-4 fw-bold"
                       style="letter-spacing:4px; text-transform:uppercase;"
                       inputmode="numeric" oninput="formatearCodigo(this)" />
            </div>
            <button type="submit" class="btn btn-danger btn-lg">Desactivar 2FA</button>
        </form>

        @section Scripts {
            <script>
                (function () {
                    const img = document.getElementById('qr');
                    const timer = document.getElementById('timer');

                    function loadQr() {
                        img.src = '@Url.Action("QrPng", "Auth")' + '?_=' + Date.now();
                    }

                    // Primer QR
                    loadQr();

                    let remaining = 60;
                    setInterval(() => {
                        remaining--;
                        if (remaining <= 0) {
                            loadQr();
                            remaining = 60;
                        }
                        timer.textContent = remaining;
                    }, 1000);
                })();

                function formatearCodigo(input) {
                    let v = input.value.replace(/\D/g, '').slice(0, 6);
                    input.value = v.length > 3 ? v.slice(0,3) + ' - ' + v.slice(3) : v;
                }

                function formatearCodigo(input) {
                  let v = input.value.replace(/\D/g, '').slice(0, 6);
                  input.value = v.length > 3 ? v.slice(0,3) + ' - ' + v.slice(3) : v;
                }
            </script>
        }
    }
    else
    {
        <h3 class="mb-3">Escaneá el QR (se regenera cada 60 s)</h3>

        <div class="d-flex flex-column align-items-center gap-3">
            <img id="qr" alt="QR" style="width:300px; height:300px; border:1px solid #eee; border-radius:8px;" />
            <div class="text-danger fw-bolder">Se actualiza en <span id="timer">60</span> s</div> <hr />

            <div class="mt-4">
                <form asp-action="ActivarAuthenticator" asp-controller="Auth" method="post" class="mt-4 d-flex flex-column align-items-center gap-3" autocomplete="one-time-code">
                    <div class="w-100" style="max-width:360px;">
                        <label for="codigo" class="form-label fw-bold">Código del Authenticator</label>
                        <input type="text" id="codigo" name="codigo"
                               maxlength="9"
                               placeholder="XXX - XXX"
                               class="form-control text-center fs-4 fw-bold"
                               style="letter-spacing: 4px; text-transform: uppercase;"
                               inputmode="numeric"
                               oninput="formatearCodigo(this)" />
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg">Activar 2FA</button>
                </form>
            </div>
        </div>

        @section Scripts {
            <script>
                (function () {
                    const img = document.getElementById('qr');
                    const timer = document.getElementById('timer');

                    function loadQr() {
                        img.src = '@Url.Action("QrPng", "Auth")' + '?_=' + Date.now();
                    }
                    loadQr();

                    let remaining = 60;
                    setInterval(() => {
                        remaining--;
                        if (remaining <= 0) { loadQr(); remaining = 60; }
                        timer.textContent = remaining;
                    }, 1000);
                })();

                function formatearCodigo(input) {
                    let v = input.value.replace(/\D/g, '').slice(0, 6);
                    input.value = v.length > 3 ? v.slice(0,3) + ' - ' + v.slice(3) : v;
                }
            </script>
        }
    }
</div>